# DPLang v1.3 - 内置函数参考

## 数学函数

```DPLang
abs(x)              # 绝对值
max(a, b, ...)      # 最大值（可变参数）
min(a, b, ...)      # 最小值
sum([1, 2, 3])      # 数组求和: 6
sum(1, 2, 3)        # 可变参数求和: 6
mean([1, 2, 3])     # 平均值: 2
median([1, 2, 3])   # 中位数: 2
sqrt(x)             # 平方根
pow(x, y)           # x的y次方
log(x)              # 自然对数
log10(x)            # 以10为底的对数
exp(x)              # e的x次方

# 取整函数
floor(x)            # 向下取整
ceil(x)             # 向上取整
round(x)            # 四舍五入
round(x, digits)    # 保留指定小数位
int(x)              # 截断小数部分
```

## 数组函数

```DPLang
len(array)                  # 数组长度
first(array)                # 第一个元素
last(array)                 # 最后一个元素
reverse(array)              # 反转数组
sort(array)                 # 排序（升序）
sort(array, desc=true)      # 降序排序
unique(array)               # 去重
concat(arr1, arr2)          # 连接数组

# 数组统计
count(array, value)         # 统计value出现次数
```

## 高阶函数

```DPLang
# 映射转换
map(array, lambda)          # 对每个元素应用函数
map(array, (val, idx) -> expr)  # 带索引的映射

# 过滤筛选
filter(array, lambda)       # 筛选满足条件的元素

# 聚合归约
reduce(array, lambda)       # 归约聚合
reduce(array, init, lambda) # 带初始值的归约

# 示例
doubled = map([1,2,3], x -> x * 2)
filtered = filter([1,2,3,4,5], x -> x > 2)
sum = reduce([1,2,3,4], (a,b) -> a + b)
```

## 数组构造函数

```DPLang
# 固定长度数组
Array(10, 0)             # 长度10，填充0: [0,0,0,0,0,0,0,0,0,0]
Array(5, 1)              # 长度5，填充1: [1,1,1,1,1]

# 生成序列
Range(1, 10)             # [1,2,3,4,5,6,7,8,9,10]
Range(0, 10, 2)          # [0,2,4,6,8,10] (步长2)
Range(10, 1, -1)         # [10,9,8,7,6,5,4,3,2,1] (倒序)

# 使用 Lambda 填充
Array(10, i -> i * 2)    # [0,2,4,6,8,10,12,14,16,18]
```

## 时间序列访问(下标索引)

```DPLang
# 单值访问(下标索引)
field[-1]           # 上一行的值(昨天)
field[-5]           # 第5行之前的值
field[1]            # 下一行的值(明天,不推荐)
field[0]            # 当前值

# 切片访问(返回数组,引用语义,不复制)
field[-5:]          # 过去5个值(不包含当前)
field[-5:0]         # 过去5个值+当前(共6个)
field[-10:-5]       # 第10到第5行的值
field[1:6]          # 未来5个值(不推荐)
field[-2:2]         # 前2+当前+后2(窗口)
field[0:0]          # 从开始到当前的所有数据

# 示例
昨收 = close[-1]
历史5天 = close[-5:0]
窗口 = close[-2:2]  # 前2天+今天+后2天
```

## 技术分析函数（TA包）

需要加载技术分析包

### 移动平均

```DPLang
MA(close, period)               # 简单移动平均
EMA(close, period)              # 指数移动平均
SMA(close, period)              # 简单移动平均（同MA）
WMA(close, period)              # 加权移动平均

# 示例
ma5 = MA(close, 5)
ma10 = MA(close, 10)
ema20 = EMA(close, 20)
```

### 趋势指标

```DPLang
# MACD 指标（返回数组）
MACD(close, fast, slow, signal) # 返回[dif, dea, macd]

# KDJ 指标（返回数组）
KDJ(high, low, close, n, m1, m2) # 返回[k, d, j]

# RSI 相对强弱指标
RSI(close, period)              # 返回0-100的值

# 布林带（返回数组）
BOLL(close, period, std)        # 返回[upper, middle, lower]

# 示例
[dif, dea, macd] = MACD(close, 12, 26, 9)
rsi14 = RSI(close, 14)
[上轨, 中轨, 下轨] = BOLL(close, 20, 2)
```

### 成交量指标

```DPLang
# 能量潮
OBV(close, volume)              # 累积能量

# 成交量均线
VOLUME_MA(volume, period)       # 成交量移动平均

# 示例
obv = OBV(close, volume)
vol_ma5 = VOLUME_MA(volume, 5)
```

### 其他指标

```DPLang
# 真实波幅
ATR(high, low, close, period)   # 波动率指标

# 顺势指标
CCI(high, low, close, period)   # 超买超卖指标

# 示例
atr14 = ATR(high, low, close, 14)
cci20 = CCI(high, low, close, 20)
```

## 安全函数

```DPLang
# 安全除法
safe_div(a, b)                      # 除零返回null
safe_div(a, b, default=0.0)         # 除零返回默认值

# 安全数组访问
safe_get(array, index)              # 越界返回null
safe_get(array, index, default=0)   # 越界返回默认值

# 安全类型转换
safe_number(value)                  # 转换失败返回null
safe_number(value, default=0)       # 转换失败返回默认值

safe_decimal(value)                 # 转换失败返回null
safe_decimal(value, default=0)      # 转换失败返回默认值

# 示例
涨幅 = safe_div(close - open, open, default=0.0)
昨收 = safe_get(历史数据, -1, default=close)
价格 = safe_number(价格文本, default=0)
```

## 控制函数

```DPLang
# 终止脚本执行
exit(message)        # 终止整个脚本（通常在 ERROR 块中使用）

# 示例
-- ERROR --
if _error.type == "CriticalError":
    exit("严重错误，终止执行: " + _error.message)
-- ERROR_END --
```

## 类型转换和检查

```DPLang
# 类型转换
int(value)           # 转为整数（截断小数）
number(value)        # 转为number类型
decimal(value)       # 转为decimal类型
string(value)        # 转为字符串
floor(value)         # 向下取整
ceil(value)          # 向上取整
round(value)         # 四舍五入
round(value, digits) # 保留指定小数位

# 类型检查
typeis(value, "number")
typeis(value, "decimal")
typeis(value, "string")
typeis(value, "bool")
typeis(value, "null")
typeis(value, "array")

# 示例
if typeis(价格, "number"):
    整数价格 = int(价格)
else:
    整数价格 = safe_number(价格, default=0)
```

## 函数组合示例

```DPLang
# 使用管道和高阶函数
成本 = 100
高利润阈值 = 50

result = prices
    |> filter(p -> p > 成本)          # 筛选高于成本
    |> map(p -> p - 成本)             # 计算利润
    |> filter(profit -> profit > 高利润阈值)
    |> reduce((sum, p) -> sum + p)    # 总利润

# 时间序列 + 高阶函数
历史20天 = close[-20:0]

# 计算连续上涨天数
连续上涨 = Range(1, 20)
    |> map(i -> close[-i] < close[-(i-1)] ? 1 : 0)
    |> reduce((count, is_up) -> is_up ? count + 1 : 0)

# 统计涨跌
涨跌统计 = 历史20天
    |> map(c -> c > c[-1] ? "涨" : "跌")
    |> reduce(
        {涨: 0, 跌: 0},
        (stats, trend) -> trend == "涨" ? {涨: stats.涨+1, 跌: stats.跌} : {涨: stats.涨, 跌: stats.跌+1}
    )
```
