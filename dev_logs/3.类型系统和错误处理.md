# DPLang v1.3 - 类型系统和错误处理

## 类型系统

### 基础类型

```DPLang
number      # 统一数值类型（底层自动选择表示）
decimal     # 高精度十进制（金融计算专用）
string      # 字符串
bool        # 布尔值
null        # 空值
array       # 数组
```

### number 类型自动提升

```DPLang
# 位宽自动提升（防溢出）
a = 100                    # number (底层int32)
b = 10000000000            # number (底层int64，自动提升)
c = a + b                  # number (底层int64)

# 类型自动提升（int → float）
x = 10                     # number (底层int)
y = 3                      # number (底层int)
z = x / y                  # number (底层float64: 3.333...)

# 显式整数除法
整数结果 = floor(x / y)     # 3
整数结果2 = int(x / y)      # 3（截断小数）

# 精度提升（number → decimal）
价格 = 100.12              # number (底层float64)
精确价格 = decimal(100.12)  # decimal (高精度)
总金额 = 精确价格 * 1000    # decimal (保持高精度)
```

### 类型转换函数

```DPLang
# 显式转换
int(3.14)           # 3 (截断小数)
floor(3.14)         # 3 (向下取整)
ceil(3.14)          # 4 (向上取整)
round(3.14)         # 3 (四舍五入)
round(3.56)         # 4
round(3.14159, 2)   # 3.14 (保留2位小数)

decimal("100.12")   # decimal类型
string(123)         # "123"
number("123.45")    # 123.45

# 类型检查
typeis(value, "number")
typeis(value, "decimal")
typeis(value, "string")
typeis(value, "bool")
typeis(value, "null")
typeis(value, "array")
```

### 输入输出类型约束

```DPLang
# 完整类型声明
-- INPUT code:string, close:number, volume:number --
-- OUTPUT code:string, signal:string, score:number --

# 类型推断（从数据自动推断）
-- INPUT code, close, volume --
-- OUTPUT code, signal, score --

# 混合模式（部分声明）
-- INPUT code:string, close, volume --  # code明确为string，其他推断

# decimal 精度模式
-- INPUT price:decimal, amount:decimal --
-- PRECISION decimal --  # 整个脚本使用decimal计算
```

## 错误处理

### ERROR 块错误处理

ERROR 块是一个**延迟声明的错误处理函数**，在脚本执行发生异常时被调用。

#### 执行机制

1. ERROR 块是声明语句，不影响后续代码的正常执行
2. 当任何语句抛出异常时，代码立即停止在出错行
3. 跳转到 ERROR 块执行错误处理逻辑
4. ERROR 块可选择返回默认值或终止脚本

```DPLang
-- INPUT code:string, price:number, shares:number --
-- OUTPUT code:string, total:number --

# 声明错误处理（不影响后续代码）
-- ERROR --
if _error.type == "ZeroDivision":
    return [code, 0]  # 返回安全值
else:
    exit("错误: " + _error.message)  # 终止脚本
-- ERROR_END --

# 正常执行流程
a = price * shares
b = a / 0          # ❌ 抛出异常，立即跳转 ERROR 块
c = b + 100        # ⛔ 不会执行（已停止在上一行）

return [code, c]   # ⛔ 不会执行
```

#### _error 对象

- `_error.type` - 错误类型
  - `"ZeroDivision"` - 除零错误
  - `"TypeError"` - 类型错误
  - `"IndexOutOfBounds"` - 数组越界
  - `"NullReference"` - 空引用
- `_error.message` - 错误描述信息
- `_error.line` - 发生错误的行号

#### 位置要求

- ⚠️ 一个脚本只能有一个 ERROR 块
- ⚠️ ERROR 块必须在 INPUT/OUTPUT 声明之后，所有代码之前
- ⚠️ ERROR 块内如果 `return`，整个脚本终止，返回指定值
- ⚠️ ERROR 块内如果 `exit()`，整个数据流终止

#### 完整示例

```DPLang
-- INPUT code:string, open:number, close:number --
-- OUTPUT code:string, 涨跌幅:number, 状态:string --

-- ERROR --
# 根据错误类型处理
if _error.type == "ZeroDivision":
    return [code, 0, "除零错误"]
if _error.type == "NullReference":
    return [code, 0, "数据缺失"]
# 其他错误终止整个流程
exit("第" + string(_error.line) + "行发生错误: " + _error.message)
-- ERROR_END --

昨收 = offset(close, -1)
涨跌幅 = (close - 昨收) / 昨收 * 100  # 可能除零

return [code, 涨跌幅, "正常"]
```

### 安全函数

使用内置安全函数避免错误，返回 null 或默认值：

```DPLang
# 安全除法
result = safe_div(a, b)                    # 除零返回null
result = safe_div(a, b, default=0.0)       # 除零返回0.0

# 安全数组访问
value = safe_get(array, index)             # 越界返回null
value = safe_get(array, index, default=0)  # 越界返回0

# 安全类型转换
num = safe_number("abc")                   # 转换失败返回null
num = safe_number("abc", default=0)        # 转换失败返回0

# 实际应用
昨收 = offset(close, -1)
涨幅 = safe_div(close - 昨收, 昨收, default=0.0) * 100
```

### 错误处理最佳实践

```DPLang
# ✅ 使用 ERROR 块处理意外异常
-- ERROR --
if _error.type == "ZeroDivision":
    return [code, 0, "除零错误"]
if _error.type == "NullReference":
    return null  # 过滤该行
exit("严重错误: " + _error.message)
-- ERROR_END --

# ✅ 对于可预见的错误使用安全函数
涨幅 = safe_div(close - open, open, default=0.0)
昨日价 = safe_get(历史数据, 0, default=close)

# ✅ 结合使用
-- ERROR --
# ERROR 块处理意外错误
exit("意外错误 at line " + string(_error.line) + ": " + _error.message)
-- ERROR_END --

# 可预见的错误用安全函数
涨幅 = safe_div(close - open, open, default=0.0)
历史数据 = past(close, 20, true)
昨日价 = safe_get(历史数据, 0, default=close)
```

## 常见错误示例

```DPLang
# 错误1：变量遮蔽
ma5 = MA(close, 5)
ma5 = ma5 * 2  # ❌ 编译错误：变量 ma5 已定义，禁止遮蔽

# 错误2：未定义变量
result = undefined_var + 1  # ❌ 编译错误：undefined_var 未定义

# 错误3：访问私有成员
value = 工具包._内部变量  # ❌ 编译错误：私有变量不可访问
工具包._私有函数()        # ❌ 编译错误：私有函数不可访问

# 错误4：数据脚本定义函数
计算():  # ❌ 编译错误：只有package脚本可定义函数
    return 1

# 错误5：修改包级状态
工具包.调用次数 = 0  # ❌ 编译错误：只有包内可修改mut变量

# 错误6：类型不匹配
-- OUTPUT code:string, value:number --
return [code, "not a number"]  # ❌ 编译错误：value应为number类型

# 错误7：返回值字段数不匹配
-- OUTPUT code:string, value:number --
return [code, 100, 200]  # ❌ 编译错误：OUTPUT声明2个字段，返回了3个

# 错误8：Lambda 修改外部变量
计数 = 0
map(array, x -> 计数 = 计数 + 1)  # ❌ 编译错误：Lambda 禁止修改外部变量

# 错误9：Lambda 参数遮蔽外部变量
x = 10
map(array, x -> x * 2)  # ❌ 编译错误：Lambda 参数 x 遮蔽外部变量

# 错误10：Lambda 定义变量
map(array, x -> { temp = x * 2; temp })  # ❌ 编译错误：Lambda 内禁止定义变量
```
