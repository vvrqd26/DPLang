# 词法结构

<cite>
**本文档引用文件**   
- [lexer.rs](file://src/lexer.rs)
- [7.解释器实现设计.md](file://dev_logs/7.解释器实现设计.md)
- [MVP实现总结.md](file://dev_logs/MVP实现总结.md)
- [2.语法参考.md](file://dev_logs/2.语法参考.md)
</cite>

## 目录
1. [标识符规则](#标识符规则)
2. [字面量类型](#字面量类型)
3. [运算符家族](#运算符家族)
4. [缩进规则](#缩进规则)
5. [特殊声明](#特殊声明)
6. [词法分析流程](#词法分析流程)
7. [错误处理](#错误处理)

## 标识符规则

DPLang的标识符规则支持现代编程语言中较为先进的特性，特别是对中文字符的原生支持。标识符的起始字符可以是英文字母、下划线（_）或中文字符，后续字符可以是字母、数字、下划线或中文字符。

在`lexer.rs`文件中，通过`is_identifier_start`和`is_identifier_continue`两个辅助函数来判断字符是否可以作为标识符的起始或后续字符。其中，`is_chinese_char`函数通过Unicode范围匹配来识别中文字符，具体范围为`\u{4E00}`到`\u{9FFF}`，这涵盖了大部分常用汉字。

例如，`涨幅`、`ma5`、`_内部变量`都是合法的标识符。关键字如`return`、`if`、`null`等在词法分析阶段会被识别为特定的`TokenType`，而不是普通标识符。

**Section sources**
- [lexer.rs](file://src/lexer.rs#L619-L625)
- [7.解释器实现设计.md](file://dev_logs/7.解释器实现设计.md#L157-L163)

## 字面量类型

DPLang支持多种字面量类型，包括数字、字符串和布尔值。

**数字字面量**支持整数、小数和科学计数法。词法分析器通过`scan_number`函数进行解析，首先读取整数部分，然后检查是否存在小数点，如果存在则继续读取小数部分。此外，还支持科学计数法，如`1.23e-4`。

**字符串字面量**使用双引号或单引号包围，支持常见的转义序列，如`\n`（换行）、`\t`（制表符）、`\\`（反斜杠）等。`scan_string`函数负责解析字符串，它会逐个字符读取，直到遇到匹配的结束引号。如果字符串未闭合，即到达文件末尾仍未找到结束引号，则会抛出“未闭合的字符串”错误。

**布尔值**字面量为`true`和`false`，在`TokenType`枚举中被定义为`True`和`False`。

**空值**字面量为`null`，在`TokenType`中定义为`Null`。

**Section sources**
- [lexer.rs](file://src/lexer.rs#L333-L369)
- [lexer.rs](file://src/lexer.rs#L372-L411)
- [lexer.rs](file://src/lexer.rs#L14-L16)

## 运算符家族

DPLang的运算符家族设计旨在提供清晰、直观的编程体验，特别是管道`|>`和Lambda`->`这两个特殊运算符。

**算术运算符**包括`+`、`-`、`*`、`/`、`%`（取模）和`^`（幂运算），分别对应`Plus`、`Minus`、`Star`、`Slash`、`Percent`和`Caret`。

**比较运算符**包括`>`、`<`、`>=`、`<=`、`==`和`!=`，分别对应`Greater`、`Less`、`GreaterEq`、`LessEq`、`Equal`和`NotEqual`。

**逻辑运算符**使用英文单词`and`、`or`和`not`，分别对应`And`、`Or`和`Not`。

**赋值和箭头**：`=`用于赋值，对应`Assign`；`->`用于Lambda表达式，对应`Arrow`。词法分析器在遇到`-`时会预读下一个字符，如果是`>`，则识别为`Arrow`，否则为`Minus`。

**管道运算符**`|>`是一个二元运算符，用于函数式编程风格的链式调用。当词法分析器遇到`|`时，会检查下一个字符是否为`>`，如果是，则识别为`Pipeline`，否则报错。

**Section sources**
- [lexer.rs](file://src/lexer.rs#L31-L70)
- [lexer.rs](file://src/lexer.rs#L511-L577)

## 缩进规则

DPLang采用基于缩进的代码块结构，类似于Python。词法分析器通过维护一个缩进栈（`indent_stack`）来实现这一功能。

当遇到换行符时，`handle_indent`函数会被调用。该函数首先计算当前行的缩进级别（空格数或Tab数，其中Tab被视为4个空格）。然后，将当前缩进级别与栈顶的缩进级别进行比较：

- 如果当前缩进级别大于栈顶级别，则表示代码块开始，将当前缩进级别压入栈，并生成一个`Indent` token。
- 如果当前缩进级别小于栈顶级别，则表示代码块结束，从栈中弹出所有大于当前缩进级别的值，并为每个弹出的值生成一个`Dedent` token。
- 如果缩进级别不匹配（即栈中不存在与当前缩进级别相等的值），则会抛出“缩进不对齐”错误。

在文件结束时，`handle_eof_dedents`函数会生成剩余的`Dedent` token，以确保所有代码块都被正确关闭。

**Section sources**
- [lexer.rs](file://src/lexer.rs#L273-L323)
- [lexer.rs](file://src/lexer.rs#L326-L330)

## 特殊声明

DPLang使用`-- XXX --`格式的特殊声明来实现特定功能，如输入输出定义、包导入和错误处理。

`scan_special_declaration`函数负责解析这些声明。它首先读取从`--`开始到行尾或下一个`--`之间的所有文本。然后，根据文本内容（不区分大小写）来确定声明类型：

- `-- INPUT ... --`：定义输入参数，内容部分会被提取并存储在`Input` token中。
- `-- OUTPUT ... --`：定义输出参数，内容部分会被提取并存储在`Output` token中。
- `-- IMPORT ... --`：导入包，内容部分会被提取并存储在`Import` token中。
- `-- ERROR --`：开始错误处理块。
- `-- ERROR_END --`：结束错误处理块。
- `-- PRECISION ... --`：设置精度模式。

如果遇到未知的特殊声明，则会抛出“未知的特殊声明”错误。

**Section sources**
- [lexer.rs](file://src/lexer.rs#L442-L507)
- [2.语法参考.md](file://dev_logs/2.语法参考.md#L11-L20)

## 词法分析流程

词法分析器（`Lexer`）是DPLang编译流程的第一步，负责将源代码字符串转换为Token流。

`Lexer`结构体包含源代码的字符向量、当前位置、行号、列号、缩进栈和待发送的Token队列。`next_token`方法是核心，它按顺序尝试识别不同类型的Token：

1. 首先检查是否有待发送的Token（如由`handle_indent`生成的`Indent`或`Dedent`）。
2. 跳过空白字符（除换行符外）。
3. 检查是否到达文件末尾，如果是，则处理剩余的`Dedent`并返回`Eof`。
4. 根据当前字符调用相应的扫描函数：
   - 换行符：调用`handle_indent`处理缩进。
   - `#`：跳过注释。
   - `-`：检查是否为特殊声明。
   - 数字：调用`scan_number`。
   - 引号：调用`scan_string`。
   - 标识符起始字符：调用`scan_identifier`。
   - 其他字符：调用`scan_operator`。

`tokenize`方法会循环调用`next_token`，直到遇到`Eof`，从而生成完整的Token序列。

**Section sources**
- [lexer.rs](file://src/lexer.rs#L158-L218)
- [lexer.rs](file://src/lexer.rs#L142-L156)

## 错误处理

词法分析器在遇到错误时会生成`LexError`，包含错误信息、行号和列号。

**缩进不对齐**：当代码块的缩进级别与之前的缩进栈不匹配时发生。例如，如果前一行缩进4个空格，而当前行缩进3个空格，由于栈中没有3个空格的级别，会触发此错误。

**未闭合的字符串**：当字符串开始引号后，直到文件末尾都没有找到匹配的结束引号时发生。`scan_string`函数在到达文件末尾时会检查这一点并抛出错误。

其他错误包括无效的数字（如`123abc`）和意外的字符（如`@`或`$`），这些都会在`scan_number`和`scan_operator`等函数中被捕获。

**Section sources**
- [lexer.rs](file://src/lexer.rs#L314-L319)
- [lexer.rs](file://src/lexer.rs#L401-L406)
- [lexer.rs](file://src/lexer.rs#L104-L110)