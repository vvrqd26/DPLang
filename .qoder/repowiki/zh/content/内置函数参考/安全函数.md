# 安全函数

<cite>
**本文档中引用的文件**  
- [builtin.rs](file://src/executor/builtin.rs)
- [4.内置函数参考.md](file://dev_logs/4.内置函数参考.md)
- [3.类型系统和错误处理.md](file://dev_logs/3.类型系统和错误处理.md)
</cite>

## 目录
1. [简介](#简介)
2. [安全除法函数 safe_div](#安全除法函数-safediv)
3. [安全数组访问函数 safe_get](#安全数组访问函数-safeget)
4. [安全类型转换函数 safe_number](#安全类型转换函数-safenumber)
5. [金融计算中的典型应用场景](#金融计算中的典型应用场景)
6. [总结](#总结)

## 简介
本文档详细说明 DPLang 语言中三个核心安全函数的设计与实现：`safe_div`、`safe_get` 和 `safe_number`。这些函数旨在防止运行时错误，如除零、数组越界和类型转换失败，通过提供默认值机制确保程序的健壮性。文档将深入分析每个函数的参数处理逻辑、错误预防机制和默认值策略，并结合金融计算中的实际应用示例进行说明。

## 安全除法函数 safe_div

`safe_div` 函数用于执行安全的除法运算，避免因除数为零而导致的运行时错误。该函数支持自定义默认值，当发生除零情况时返回指定的默认值而非抛出异常。

函数接受 2 到 3 个参数：
- 第一个参数为被除数（a）
- 第二个参数为除数（b）
- 第三个参数为可选的默认值（default），若未提供则默认为 0.0

当除数 b 为 0.0 时，函数返回默认值；否则返回 a / b 的计算结果。此机制确保了在金融计算等场景中，即使出现除零情况，程序也能继续执行并返回一个合理的替代值。

**Section sources**
- [builtin.rs](file://src/executor/builtin.rs#L498-L518)
- [4.内置函数参考.md](file://dev_logs/4.内置函数参考.md#L171-L175)

## 安全数组访问函数 safe_get

`safe_get` 函数提供了一种安全的方式来访问数组元素，有效防止数组越界错误。它支持负索引（用于访问从数组末尾开始的元素）和越界处理，允许用户指定一个默认值在访问失败时返回。

函数接受 2 到 3 个参数：
- 第一个参数为目标数组
- 第二个参数为索引值（支持负数）
- 第三个参数为可选的默认值（default），若未提供则默认为 null

对于负索引，函数会将其转换为正向索引（例如，-1 表示最后一个元素）。如果计算出的实际索引超出数组范围，则返回默认值。这一设计使得在处理时间序列数据或历史数据时更加灵活和安全。

**Section sources**
- [builtin.rs](file://src/executor/builtin.rs#L520-L555)
- [4.内置函数参考.md](file://dev_logs/4.内置函数参考.md#L176-L178)

## 安全类型转换函数 safe_number

`safe_number` 函数用于安全地将任意值转换为数值类型，避免因类型不兼容导致的转换错误。当转换失败时，函数返回用户指定的默认值，从而保证程序的连续性。

函数接受 1 到 2 个参数：
- 第一个参数为待转换的值
- 第二个参数为可选的默认值（default），若未提供则默认为 0

函数尝试将输入值转换为 `f64` 类型，若成功则返回转换后的数值；若失败（如字符串无法解析为数字），则返回默认值。此功能在处理用户输入或外部数据源时尤为重要，可有效避免因数据格式问题引发的异常。

**Section sources**
- [builtin.rs](file://src/executor/builtin.rs#L557-L574)
- [4.内置函数参考.md](file://dev_logs/4.内置函数参考.md#L180-L182)

## 金融计算中的典型应用场景

在金融数据分析和计算中，数据缺失、除零和类型错误是常见的问题。`safe_div`、`safe_get` 和 `safe_number` 函数为此类场景提供了可靠的解决方案。

例如，在计算股票涨幅时，可以使用 `safe_div(close - open, open, default=0.0)` 来避免开盘价为零导致的除零错误；在获取历史收盘价时，使用 `safe_get(历史数据, -1, default=close)` 可以安全地访问前一天的数据，即使当前为第一行数据也不会出错；在处理价格文本数据时，`safe_number(价格文本, default=0)` 能确保即使某些价格字段为空或格式错误，也能返回一个默认的数值继续计算。

这些函数的组合使用显著提升了金融脚本的鲁棒性和可维护性，减少了对复杂错误处理逻辑的依赖。

**Section sources**
- [3.类型系统和错误处理.md](file://dev_logs/3.类型系统和错误处理.md#L171-L174)
- [4.内置函数参考.md](file://dev_logs/4.内置函数参考.md#L187-L190)

## 总结
`safe_div`、`safe_get` 和 `safe_number` 是 DPLang 中不可或缺的安全函数，它们通过内置的错误预防机制和灵活的默认值策略，极大地增强了程序的稳定性和容错能力。在金融计算等对数据质量要求较高的领域，这些函数的应用能够有效避免常见运行时错误，确保数据处理流程的顺畅执行。