# 测试建议

<cite>
**Referenced Files in This Document**   
- [dev_logs/6.最佳实践.md](file://dev_logs/6.最佳实践.md)
- [src/executor/tests.rs](file://src/executor/tests.rs)
- [dev_logs/3.类型系统和错误处理.md](file://dev_logs/3.类型系统和错误处理.md)
- [BACKTEST_TESTING.md](file://BACKTEST_TESTING.md)
- [src/executor/data_stream.rs](file://src/executor/data_stream.rs)
</cite>

## 目录
1. [引言](#引言)
2. [边界条件测试](#边界条件测试)
3. [性能测试](#性能测试)
4. [测试实践总结](#测试实践总结)

## 引言

本文档旨在为DPLang开发者提供全面的测试实践指南，帮助构建健壮的测试用例。文档基于`dev_logs/6.最佳实践.md`中的测试示例，结合代码库中的实际实现，重点阐述边界条件测试和性能测试两大核心领域。通过遵循这些最佳实践，开发者可以确保脚本在各种场景下的正确性和稳定性。

## 边界条件测试

边界条件测试是确保代码健壮性的关键环节，主要关注空值、除零、数组越界等异常情况，并结合ERROR块进行处理。

### ERROR块错误处理机制

ERROR块是DPLang中用于处理运行时异常的延迟声明错误处理函数。其执行机制如下：
1. ERROR块作为声明语句，不影响后续代码的正常执行流程
2. 当任何语句抛出异常时，代码立即停止在出错行
3. 控制权跳转到ERROR块执行错误处理逻辑
4. ERROR块可选择返回默认值或终止脚本执行

ERROR块必须遵循以下位置要求：
- 一个脚本只能有一个ERROR块
- ERROR块必须在INPUT/OUTPUT声明之后，所有业务代码之前
- ERROR块内如果使用`return`，整个脚本终止并返回指定值
- ERROR块内如果使用`exit()`，整个数据流终止

**_error对象**提供了详细的错误信息：
- `_error.type` - 错误类型，包括"ZeroDivision"(除零错误)、"TypeError"(类型错误)、"IndexOutOfBounds"(数组越界)、"NullReference"(空引用)
- `_error.message` - 错误描述信息

### 安全函数的使用

对于可预见的错误，推荐使用内置安全函数来避免异常，这些函数会返回null或指定的默认值：

```DPLang
# 安全除法
result = safe_div(a, b)                    # 除零返回null
result = safe_div(a, b, default=0.0)       # 除零返回0.0

# 安全数组访问
value = safe_get(array, index)             # 越界返回null
value = safe_get(array, index, default=0)  # 越界返回0

# 安全类型转换
num = safe_number("abc")                   # 转换失败返回null
num = safe_number("abc", default=0)        # 转换失败返回0
```

### 结合使用ERROR块和安全函数

最佳实践是结合使用ERROR块和安全函数，形成分层的错误处理策略：

```DPLang
# 使用 ERROR 块处理意外异常
-- ERROR --
if _error.type == "ZeroDivision":
    return [code, 0, "除零错误"]
if _error.type == "NullReference":
    return null  # 过滤该行
exit("严重错误: " + _error.message)
-- ERROR_END --

# 对于可预见的错误使用安全函数
涨幅 = safe_div(close - open, open, default=0.0)
昨日价 = safe_get(历史数据, 0, default=close)
```

### 边界情况测试示例

在实际测试中，需要覆盖各种边界情况：

**空交易策略测试**：验证从不发出买入信号的策略
- 预期交易次数为0
- 总收益为0
- 不应出错

**数据异常测试**：验证缺失字段、空数据等情况
- 测试缺少必要字段（如close字段）的输入
- 预期有友好的错误提示
- 明确指出缺少的字段

**除零错误测试**：验证ERROR块正确处理除零情况
- 在测试用例中设置分母为0
- 验证ERROR块返回预期的默认值
- 确保脚本不会崩溃

**空值处理测试**：验证null值的正确处理
- 测试输入包含null值的情况
- 验证安全函数（如safe_get）正确返回null或默认值
- 确保业务逻辑能正确处理null值

**数组越界测试**：验证历史数据访问的边界情况
- 测试访问不存在的历史数据
- 验证返回null或默认值
- 确保不会抛出IndexOutOfBounds异常

**Section sources**
- [dev_logs/3.类型系统和错误处理.md](file://dev_logs/3.类型系统和错误处理.md#L82-L203)
- [BACKTEST_TESTING.md](file://BACKTEST_TESTING.md#L152-L218)
- [src/executor/tests.rs](file://src/executor/tests.rs#L182-L230)

## 性能测试

性能测试旨在验证大数据量下的执行效率，重点关注历史数据引用、管道优化和避免重复计算等性能关键点。

### 历史数据引用优化

DPLang通过引用语义优化历史数据访问，避免不必要的数据复制。在`src/executor/data_stream.rs`中，`DataStreamExecutor`使用Rc<Vec<HashMap<String, Value>>>来共享输入矩阵，实现零拷贝：

```rust
/// 输入矩阵（只读引用，使用 Rc 共享，零拷贝）
input_matrix: Rc<Vec<HashMap<String, Value>>>,
```

历史数据引用通过`get_input_slice`方法实现，该方法构建列数据切片而不复制原始数据：

```DPLang
# 大数据量测试 - 历史数据引用（不复制）
历史数据 = close[-100:0]  # 引用，不复制
```

### 管道优化

管道操作符（|>）是DPLang中重要的性能优化手段。最佳实践是先过滤再计算，以减少后续操作的数据量：

```DPLang
# 先过滤再计算 - 性能优化
result = large_dataset
    |> filter(x -> x > 阈值)  # 先过滤
    |> map(x -> 复杂计算(x))   # 对少量数据进行复杂计算

# 不推荐：先映射大量数据，再过滤
result = large_dataset
    |> map(x -> 复杂计算(x))   # 对所有数据计算
    |> filter(x -> x > 阈值)  # 然后过滤
```

### 避免重复计算

避免重复计算是提升性能的关键。最佳实践是将计算结果存储在变量中，然后多次引用：

```DPLang
# 好：时间序列只计算一次（引用语义）
历史数据 = close[-20:0]
最大值 = max(...历史数据)
最小值 = min(...历史数据)
平均值 = mean(历史数据)

# 差：重复计算（低效）
最大值 = max(...close[-20:0])
最小值 = min(...close[-20:0])
平均值 = mean(close[-20:0])
```

### 性能测试策略

**大数据量测试**：使用大规模数据集验证脚本的执行效率
- 测试包含数千行数据的输入文件
- 监控内存使用情况
- 测量执行时间

**历史数据引用测试**：验证历史数据引用的正确性和性能
- 测试长周期的历史数据访问（如close[-1000:0]）
- 验证不会发生内存溢出
- 确保访问效率与数据量成线性关系

**管道链性能测试**：验证复杂管道链的执行效率
- 构建包含多个filter、map、reduce操作的管道链
- 测试不同数据量下的执行时间
- 验证先过滤后计算的优化效果

**重复计算影响测试**：量化重复计算对性能的影响
- 对比有无重复计算的两个版本
- 测量执行时间差异
- 分析CPU和内存使用情况

**Section sources**
- [dev_logs/6.最佳实践.md](file://dev_logs/6.最佳实践.md#L517-L532)
- [src/executor/data_stream.rs](file://src/executor/data_stream.rs#L1-L338)
- [src/executor/tests.rs](file://src/executor/tests.rs#L268-L309)

## 测试实践总结

综合边界条件测试和性能测试的最佳实践，开发者应遵循以下指导原则：

1. **分层错误处理**：结合使用ERROR块处理意外异常和安全函数处理可预见错误，形成完整的错误处理策略。

2. **全面覆盖边界情况**：确保测试用例覆盖空值、除零、数组越界等各种边界条件，提高代码的健壮性。

3. **优化数据处理流程**：利用管道操作符构建高效的数据处理链，遵循先过滤后计算的原则。

4. **避免不必要的计算**：通过变量存储和引用语义避免重复计算，提升执行效率。

5. **性能监控**：在开发过程中持续监控脚本的性能表现，及时发现和解决性能瓶颈。

6. **测试驱动开发**：在编写业务逻辑之前先编写测试用例，确保代码从一开始就具备良好的可测试性和健壮性。

通过遵循这些测试实践，开发者可以构建出既正确又高效的DPLang脚本，确保在各种场景下都能稳定运行。

**Section sources**
- [dev_logs/6.最佳实践.md](file://dev_logs/6.最佳实践.md#L495-L532)
- [dev_logs/3.类型系统和错误处理.md](file://dev_logs/3.类型系统和错误处理.md#L82-L203)
- [BACKTEST_TESTING.md](file://BACKTEST_TESTING.md#L152-L218)