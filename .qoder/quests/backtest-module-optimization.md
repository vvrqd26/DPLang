# 回测模块优化设计

## 一、现状分析

### 当前实现的主要问题

1. **报表功能薄弱**
   - 仅输出总收益和胜率两个基础指标
   - 缺少关键风险指标（最大回撤、夏普比率等）
   - 无交易明细和持仓分析
   - 无可视化输出

2. **功能单一**
   - 只支持单策略单标的回测
   - 无参数优化能力
   - 无滑点、手续费等真实交易成本模拟
   - 缺少资金管理机制

3. **数据输出不友好**
   - 仅输出单一CSV文件
   - 统计信息仅在控制台打印
   - 无结构化报告输出
   - 难以进行对比分析

4. **易用性不足**
   - 缺少策略模板和示例
   - 错误提示不够友好
   - 无进度显示
   - 结果解读困难

### 已有的优势基础

1. 流式数据处理架构成熟
2. CSV输入输出机制完善
3. 列式存储优化已实现
4. 命令行接口清晰

## 二、优化目标

### 核心目标

1. **完善回测报表体系**：提供专业级回测报告
2. **增强功能完整性**：支持交易成本、资金管理等真实场景
3. **提升易用性**：简化使用流程，提供清晰的结果展示
4. **保持高性能**：利用现有流式架构，确保大数据回测效率

## 三、功能设计

### 3.1 回测配置体系

#### 回测参数配置

提供两种配置方式：

**方式一：命令行参数**
```
dplang backtest <strategy.dp> <data.csv> \
  --initial-capital 100000 \
  --commission 0.0003 \
  --slippage 0.001 \
  --output results/
```

**方式二：配置文件**
```
dplang backtest <strategy.dp> <data.csv> --config backtest.toml
```

配置项说明：

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| initial_capital | 初始资金 | 100000 |
| commission_rate | 手续费率 | 0.0003 |
| slippage_rate | 滑点率 | 0.001 |
| min_commission | 最小手续费 | 5.0 |
| position_limit | 单次最大仓位比例 | 1.0 |
| enable_short | 是否允许做空 | false |
| benchmark | 基准标的（用于对比） | 无 |

#### 输出配置

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| output_dir | 输出目录 | ./backtest_results |
| save_trades | 保存交易明细 | true |
| save_positions | 保存持仓记录 | true |
| save_daily_stats | 保存每日统计 | true |
| generate_html_report | 生成HTML报告 | false |
| verbose | 详细输出模式 | false |

### 3.2 核心指标体系

#### 收益指标

| 指标名称 | 计算方法 | 说明 |
|---------|---------|------|
| 总收益 | (期末资产 - 初始资金) / 初始资金 | 整体收益率 |
| 年化收益率 | (1 + 总收益)^(365/交易天数) - 1 | 标准化收益 |
| 基准收益率 | 基准标的涨跌幅 | 对比基准 |
| 超额收益 | 策略收益 - 基准收益 | 相对表现 |
| 累计收益曲线 | 每日累计收益序列 | 可视化基础 |

#### 风险指标

| 指标名称 | 计算方法 | 说明 |
|---------|---------|------|
| 最大回撤 | max((峰值 - 当前值) / 峰值) | 最大亏损幅度 |
| 最大回撤持续期 | 从峰值到新高的最长天数 | 恢复能力 |
| 年化波动率 | std(日收益率) × √252 | 风险水平 |
| 下行波动率 | std(负收益日收益率) × √252 | 下行风险 |
| VaR(95%) | 日收益率5%分位数 | 风险价值 |

#### 综合评价指标

| 指标名称 | 计算方法 | 说明 |
|---------|---------|------|
| 夏普比率 | (年化收益 - 无风险利率) / 年化波动率 | 风险调整收益 |
| 索提诺比率 | (年化收益 - 无风险利率) / 下行波动率 | 下行风险调整收益 |
| 卡玛比率 | 年化收益 / 最大回撤 | 回撤调整收益 |
| 信息比率 | 超额收益 / 跟踪误差 | 相对基准表现 |
| 胜率 | 盈利交易次数 / 总交易次数 | 交易成功率 |
| 盈亏比 | 平均盈利 / 平均亏损 | 盈亏对比 |

#### 交易统计

| 指标名称 | 说明 |
|---------|------|
| 总交易次数 | 买入卖出成对计数 |
| 盈利交易次数 | 盈利次数 |
| 亏损交易次数 | 亏损次数 |
| 平均持仓天数 | 每次交易平均持仓时间 |
| 最长持仓天数 | 单次最长持仓 |
| 平均盈利 | 盈利交易平均收益 |
| 平均亏损 | 亏损交易平均损失 |
| 最大单笔盈利 | 单次最高收益 |
| 最大单笔亏损 | 单次最大损失 |
| 连续盈利次数 | 最长连胜 |
| 连续亏损次数 | 最长连亏 |

### 3.3 报表输出设计

#### 输出文件结构

```
backtest_results/
├── summary.json              # 回测摘要（JSON格式）
├── summary.txt               # 回测摘要（文本格式）
├── metrics.csv               # 所有指标汇总
├── trades.csv                # 交易明细
├── positions.csv             # 持仓记录
├── daily_stats.csv           # 每日统计
├── equity_curve.csv          # 资金曲线
└── report.html               # HTML可视化报告（可选）
```

#### summary.json 结构

```
{
  "basic_info": {
    "strategy": "双均线交叉策略",
    "data_file": "history.csv",
    "start_date": "2023-01-01",
    "end_date": "2023-12-31",
    "trading_days": 243,
    "initial_capital": 100000
  },
  "return_metrics": {
    "total_return": 0.2536,
    "annual_return": 0.2584,
    "benchmark_return": 0.1823,
    "excess_return": 0.0713
  },
  "risk_metrics": {
    "max_drawdown": 0.1245,
    "max_drawdown_duration": 45,
    "annual_volatility": 0.1876,
    "downside_volatility": 0.1234,
    "var_95": -0.0213
  },
  "performance_metrics": {
    "sharpe_ratio": 1.38,
    "sortino_ratio": 2.09,
    "calmar_ratio": 2.08,
    "information_ratio": 0.87,
    "win_rate": 0.58,
    "profit_loss_ratio": 1.85
  },
  "trade_statistics": {
    "total_trades": 48,
    "winning_trades": 28,
    "losing_trades": 20,
    "avg_holding_days": 5.2,
    "max_holding_days": 15,
    "avg_profit": 0.0342,
    "avg_loss": -0.0185,
    "max_profit": 0.0876,
    "max_loss": -0.0456,
    "max_consecutive_wins": 7,
    "max_consecutive_losses": 4
  }
}
```

#### summary.txt 格式示例

```
═══════════════════════════════════════════════════════════
                    回测报告摘要
═══════════════════════════════════════════════════════════

【基本信息】
  策略名称: 双均线交叉策略
  数据文件: history.csv
  回测区间: 2023-01-01 至 2023-12-31
  交易天数: 243天
  初始资金: 100,000.00

【收益指标】
  总收益率:          25.36%
  年化收益率:        25.84%
  基准收益率:        18.23%
  超额收益:           7.13%

【风险指标】
  最大回撤:          12.45%
  最大回撤持续期:    45天
  年化波动率:        18.76%
  下行波动率:        12.34%
  VaR(95%):          -2.13%

【综合评价】
  夏普比率:          1.38
  索提诺比率:        2.09
  卡玛比率:          2.08
  信息比率:          0.87
  胜率:              58.33%
  盈亏比:            1.85

【交易统计】
  总交易次数:        48
  盈利次数:          28
  亏损次数:          20
  平均持仓天数:      5.2天
  最长持仓:          15天
  平均盈利:          3.42%
  平均亏损:         -1.85%
  最大单笔盈利:      8.76%
  最大单笔亏损:     -4.56%
  最长连续盈利:      7次
  最长连续亏损:      4次

═══════════════════════════════════════════════════════════
```

#### trades.csv 结构

| 字段 | 说明 |
|------|------|
| trade_id | 交易编号 |
| entry_date | 开仓日期 |
| entry_price | 开仓价格 |
| entry_signal | 开仓信号 |
| exit_date | 平仓日期 |
| exit_price | 平仓价格 |
| exit_signal | 平仓信号 |
| shares | 持仓数量 |
| holding_days | 持仓天数 |
| gross_profit | 毛利润 |
| commission | 手续费 |
| net_profit | 净利润 |
| return_rate | 收益率 |

#### positions.csv 结构

| 字段 | 说明 |
|------|------|
| date | 日期 |
| signal | 当日信号 |
| price | 当日价格 |
| shares | 持仓数量 |
| position_value | 持仓市值 |
| cash | 现金余额 |
| total_value | 总资产 |
| return | 当日收益率 |
| cumulative_return | 累计收益率 |

#### daily_stats.csv 结构

| 字段 | 说明 |
|------|------|
| date | 日期 |
| total_value | 总资产 |
| return | 当日收益率 |
| cumulative_return | 累计收益率 |
| drawdown | 当前回撤 |
| benchmark_value | 基准市值 |
| benchmark_return | 基准收益率 |

### 3.4 交易成本模拟

#### 手续费计算

- 买入手续费 = max(买入金额 × 手续费率, 最小手续费)
- 卖出手续费 = max(卖出金额 × 手续费率, 最小手续费)
- 印花税 = 卖出金额 × 印花税率（仅卖出收取）

#### 滑点模拟

- 买入实际价格 = 信号价格 × (1 + 滑点率)
- 卖出实际价格 = 信号价格 × (1 - 滑点率)

#### 资金管理规则

- 单次最大买入金额 = 可用现金 × 仓位限制比例
- 卖出数量 = min(信号数量, 当前持仓)
- 现金不足时拒绝买入信号

### 3.5 基准对比功能

#### 基准数据处理

- 支持指定基准标的代码
- 自动从数据中提取基准价格
- 计算基准收益曲线

#### 对比指标

- 相对收益：策略收益 - 基准收益
- 跟踪误差：策略与基准收益率差异的标准差
- 信息比率：相对收益 / 跟踪误差
- Beta值：策略相对基准的波动倍数
- Alpha值：策略超额收益

### 3.6 增强的命令行交互

#### 执行过程进度显示

```
📈 策略回测模式
策略: ma_crossover_strategy.dp
历史数据: history.csv
初始资金: 100,000.00
手续费率: 0.03%
滑点率: 0.10%

✅ 加载 5000 条历史数据
✅ 脚本解析成功

🚀 开始回测...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100% [5000/5000] 耗时: 1.23s

✅ 回测完成! 

📊 快速摘要
  总收益:    25.36%
  最大回撤:  12.45%
  夏普比率:  1.38
  胜率:      58.33%

📁 详细报告已保存到: ./backtest_results/
  - summary.txt        回测摘要
  - trades.csv         交易明细 (48笔)
  - positions.csv      持仓记录 (5000行)
  - daily_stats.csv    每日统计
  - equity_curve.csv   资金曲线
```

#### 错误和警告提示优化

```
⚠️  警告: 策略脚本缺少 'position' 输出字段，将使用默认仓位计算
⚠️  警告: 第156天出现现金不足，买入信号被忽略
❌ 错误: 数据文件缺少必需的 'close' 字段
💡 提示: 建议在脚本中明确定义 INPUT 和 OUTPUT 字段
```

## 四、技术实现方案

### 4.1 模块架构

#### 新增模块结构

```
src/
  backtest/
    mod.rs                    # 模块入口和导出
    engine.rs                 # 回测引擎核心
    portfolio.rs              # 资金和持仓管理
    performance.rs            # 性能指标计算
    trade_tracker.rs          # 交易记录跟踪
    reporter.rs               # 报告生成器
    config.rs                 # 回测配置
```

#### 模块职责划分

| 模块 | 职责 |
|------|------|
| engine.rs | 回测流程控制、信号执行、时间推进 |
| portfolio.rs | 现金管理、持仓跟踪、资产计算 |
| performance.rs | 各类指标计算（收益、风险、综合） |
| trade_tracker.rs | 交易明细记录、交易统计 |
| reporter.rs | 生成各种格式报告（JSON、TXT、CSV） |
| config.rs | 配置参数定义和解析 |

### 4.2 核心数据结构

#### BacktestConfig 回测配置

```
结构定义：
  - initial_capital: f64           初始资金
  - commission_rate: f64           手续费率
  - slippage_rate: f64             滑点率
  - min_commission: f64            最小手续费
  - stamp_duty_rate: f64           印花税率
  - position_limit: f64            最大仓位比例
  - enable_short: bool             是否允许做空
  - benchmark: Option<String>      基准标的
  - output_config: OutputConfig    输出配置
```

#### Portfolio 投资组合状态

```
结构定义：
  - cash: f64                      现金余额
  - shares: f64                    持仓数量
  - total_value: f64               总资产
  - positions: Vec<Position>       持仓历史
  - peak_value: f64                历史最高净值
  - drawdown: f64                  当前回撤
```

#### Trade 交易记录

```
结构定义：
  - trade_id: usize                交易编号
  - entry_date: String             开仓日期
  - entry_price: f64               开仓价格
  - exit_date: String              平仓日期
  - exit_price: f64                平仓价格
  - shares: f64                    交易数量
  - gross_profit: f64              毛利润
  - commission: f64                手续费
  - net_profit: f64                净利润
  - return_rate: f64               收益率
  - holding_days: usize            持仓天数
```

#### PerformanceMetrics 性能指标

```
结构定义：
  - return_metrics: ReturnMetrics         收益指标
  - risk_metrics: RiskMetrics             风险指标
  - performance_metrics: PerformanceMetrics  综合指标
  - trade_statistics: TradeStatistics     交易统计
```

### 4.3 回测引擎流程

#### 主流程设计

```
步骤1: 初始化
  - 加载配置参数
  - 初始化投资组合（现金 = initial_capital）
  - 创建交易跟踪器
  - 准备数据流执行器

步骤2: 逐行处理数据
  For each 数据行:
    a. 执行策略脚本获取信号
    b. 解析信号（买入/卖出/持有）
    c. 根据信号执行交易
       - 计算交易价格（含滑点）
       - 计算手续费
       - 更新现金和持仓
       - 记录交易明细
    d. 计算当日资产
       - 持仓市值 = shares × price
       - 总资产 = cash + 持仓市值
    e. 更新回撤
       - 如果资产创新高，更新peak_value
       - 计算当前回撤
    f. 记录每日统计

步骤3: 计算性能指标
  - 调用 PerformanceCalculator 计算所有指标
  - 汇总交易统计信息

步骤4: 生成报告
  - 生成 summary.json
  - 生成 summary.txt
  - 输出 trades.csv
  - 输出 positions.csv
  - 输出 daily_stats.csv
  - 可选：生成 HTML 报告

步骤5: 输出到控制台
  - 打印快速摘要
  - 提示报告文件位置
```

#### 信号执行逻辑

```
信号解析：
  从脚本输出中提取 'signal' 字段
  支持的信号值：
    - "买入" / "buy" / 1
    - "卖出" / "sell" / -1
    - "持有" / "hold" / 0

买入执行：
  IF 信号 == "买入":
    可买金额 = cash × position_limit
    买入价格 = price × (1 + slippage_rate)
    买入数量 = 可买金额 / 买入价格
    手续费 = max(可买金额 × commission_rate, min_commission)
    
    IF cash >= 买入数量 × 买入价格 + 手续费:
      shares += 买入数量
      cash -= 买入数量 × 买入价格 + 手续费
      记录开仓
    ELSE:
      输出警告：现金不足
      忽略信号

卖出执行：
  IF 信号 == "卖出" AND shares > 0:
    卖出价格 = price × (1 - slippage_rate)
    卖出金额 = shares × 卖出价格
    手续费 = max(卖出金额 × commission_rate, min_commission)
    印花税 = 卖出金额 × stamp_duty_rate
    
    cash += 卖出金额 - 手续费 - 印花税
    shares = 0
    记录平仓
```

### 4.4 性能指标计算算法

#### 最大回撤计算

```
算法：
  max_drawdown = 0
  peak_value = initial_capital
  
  For each day_value in equity_curve:
    IF day_value > peak_value:
      peak_value = day_value
    
    drawdown = (peak_value - day_value) / peak_value
    
    IF drawdown > max_drawdown:
      max_drawdown = drawdown
  
  return max_drawdown
```

#### 夏普比率计算

```
算法：
  日收益率序列 = [(V[i] - V[i-1]) / V[i-1] for i in 1..N]
  平均日收益率 = mean(日收益率序列)
  日收益率标准差 = std(日收益率序列)
  
  年化收益率 = (1 + 平均日收益率)^252 - 1
  年化波动率 = 日收益率标准差 × sqrt(252)
  
  无风险利率 = 0.03  # 可配置
  
  夏普比率 = (年化收益率 - 无风险利率) / 年化波动率
  
  return 夏普比率
```

#### 索提诺比率计算

```
算法：
  日收益率序列 = [(V[i] - V[i-1]) / V[i-1] for i in 1..N]
  负收益序列 = [r for r in 日收益率序列 if r < 0]
  
  下行波动率 = std(负收益序列) × sqrt(252)
  年化收益率 = (终值 / 初值)^(252/交易天数) - 1
  
  索提诺比率 = (年化收益率 - 无风险利率) / 下行波动率
  
  return 索提诺比率
```

### 4.5 报告生成器设计

#### Reporter 接口设计

```
功能方法：
  - generate_summary_json()     生成JSON摘要
  - generate_summary_text()     生成文本摘要
  - generate_trades_csv()       生成交易明细CSV
  - generate_positions_csv()    生成持仓记录CSV
  - generate_daily_stats_csv()  生成每日统计CSV
  - generate_all()              生成所有报告
```

#### 文本格式化规则

- 数字格式：
  - 百分比：保留2位小数，添加%符号
  - 金额：千分位分隔，保留2位小数
  - 比率：保留2位小数
  - 天数：整数
  
- 对齐方式：
  - 标题左对齐
  - 数值右对齐
  - 使用等宽字符绘制边框

### 4.6 集成到现有命令行

#### 修改 main.rs 中的 run_backtest_mode

```
主要变更：
  1. 解析命令行参数生成 BacktestConfig
  2. 创建 BacktestEngine 实例
  3. 调用 engine.run() 执行回测
  4. 调用 Reporter 生成报告
  5. 控制台输出优化后的摘要信息
```

#### 向后兼容性

- 保持现有命令行参数接口
- 新参数均为可选，提供默认值
- 不破坏现有策略脚本

## 五、实施计划

### 阶段一：核心指标计算（高优先级）

**目标**：完善性能指标体系

**任务**：
1. 创建 backtest 模块目录结构
2. 实现 performance.rs 模块
   - ReturnMetrics 收益指标计算
   - RiskMetrics 风险指标计算
   - PerformanceMetrics 综合指标计算
   - TradeStatistics 交易统计
3. 单元测试：各指标计算准确性验证

**交付物**：
- src/backtest/performance.rs
- 完整的指标计算函数库
- 单元测试覆盖率 > 90%

### 阶段二：回测引擎优化（高优先级）

**目标**：实现交易成本和资金管理

**任务**：
1. 实现 portfolio.rs 模块
   - 资金和持仓管理
   - 交易成本计算
   - 资产净值计算
2. 实现 trade_tracker.rs 模块
   - 交易记录跟踪
   - 开平仓配对
3. 实现 engine.rs 模块
   - 信号执行逻辑
   - 回测主流程控制
4. 实现 config.rs 模块
   - 配置参数定义
   - 命令行参数解析

**交付物**：
- 完整的回测引擎
- 支持手续费、滑点、印花税
- 支持资金管理规则

### 阶段三：报告生成系统（中优先级）

**目标**：提供专业级回测报告

**任务**：
1. 实现 reporter.rs 模块
   - JSON 格式摘要生成
   - TXT 格式摘要生成
   - CSV 格式明细输出
2. 设计美观的文本报告模板
3. 集成到命令行输出

**交付物**：
- 多格式报告生成器
- 美观的控制台输出
- 完整的输出文件集

### 阶段四：增强功能（中优先级）

**目标**：提升易用性和功能完整性

**任务**：
1. 基准对比功能
   - 基准数据提取
   - 相对指标计算
2. 配置文件支持
   - TOML 配置解析
3. 进度显示优化
   - 进度条显示
   - 详细日志模式

**交付物**：
- 基准对比功能
- backtest.toml 配置支持
- 优化的用户体验

### 阶段五：文档和示例（中优先级）

**目标**：完善使用文档

**任务**：
1. 编写回测使用指南
2. 提供策略模板示例
3. 性能指标说明文档
4. 最佳实践指南

**交付物**：
- BACKTEST_GUIDE.md
- 示例策略集合
- 指标说明文档

### 阶段六：HTML报告（低优先级）

**目标**：可视化报告

**任务**：
1. 设计 HTML 报告模板
2. 集成图表库（可考虑生成 matplotlib 脚本）
3. 资金曲线图、回撤图生成

**交付物**：
- HTML 可视化报告
- 图表展示

## 六、测试策略

### 单元测试

**覆盖范围**：
- 所有指标计算函数
- 交易成本计算
- 信号执行逻辑
- 数据结构序列化

**测试数据**：
- 构造简单价格序列
- 已知结果验证
- 边界情况测试

### 集成测试

**测试场景**：
1. 完整回测流程
2. 多种信号类型
3. 极端市场情况（暴涨暴跌）
4. 现金不足场景
5. 空仓场景

### 性能测试

**测试目标**：
- 1万条数据回测时间 < 1秒
- 10万条数据回测时间 < 10秒
- 内存占用合理

## 七、性能优化考虑

### 利用现有优化

1. **流式处理**：逐行处理，内存占用低
2. **列式存储**：高效的数据访问
3. **上下文池**：减少对象创建开销

### 新增优化点

1. **指标增量计算**：
   - 部分指标可采用增量方式
   - 避免重复遍历整个序列

2. **延迟计算**：
   - 仅在需要时计算高级指标
   - 分阶段计算，渐进式输出

3. **并行化（可选）**：
   - 多策略回测可并行
   - 参数优化场景的并行支持

## 八、易用性提升措施

### 智能默认值

- 手续费率：万3（A股常见费率）
- 滑点率：千1
- 初始资金：10万
- 印花税率：千1（仅卖出）

### 友好的错误提示

- 缺少字段时给出明确提示
- 数据异常时指出具体位置
- 提供修复建议

### 进度反馈

- 实时显示处理进度
- 预估剩余时间
- 关键节点提示

### 结果解读辅助

- 在摘要中添加指标解释
- 提供性能评级（优秀/良好/一般/较差）
- 突出显示关键问题

## 九、风险和限制

### 当前限制

1. **单标的回测**：暂不支持多标的组合
2. **固定仓位**：仅支持全仓买卖或按比例
3. **简化滑点**：固定比例，非市场深度模型
4. **无资金曲线拟合**：不预测未来表现

### 未来扩展方向

1. **投资组合回测**：支持多标的组合策略
2. **高级仓位管理**：Kelly公式、固定比例等
3. **更真实的交易模拟**：市场深度、限价单
4. **参数优化工具**：网格搜索、遗传算法
5. **在线回测**：实时数据流接入

## 十、成功标准

### 功能完整性

- ✅ 支持至少15个核心性能指标
- ✅ 提供完整的交易明细输出
- ✅ 生成专业格式的回测报告
- ✅ 支持交易成本模拟
- ✅ 提供基准对比功能

### 性能指标

- ✅ 1万条数据回测时间 < 1秒
- ✅ 单元测试覆盖率 > 90%
- ✅ 所有核心指标计算准确性验证通过

### 易用性

- ✅ 命令行参数清晰易懂
- ✅ 错误提示友好明确
- ✅ 控制台输出美观易读
- ✅ 提供完整的使用文档

### 向后兼容

- ✅ 不破坏现有策略脚本
- ✅ 保持现有命令行接口
- ✅ 新功能通过可选参数启用
